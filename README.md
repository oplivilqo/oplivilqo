# 🎭魔法少女的魔女裁判 文本框生成器

一个基于Python的自动化表情包生成工具，能够快速生成带有自定义文本的魔法少女的魔女裁判文本框图片。[灵感来源与代码参考](https://github.com/MarkCup-Official/Anan-s-Sketchbook-Chat-Box)

## To-Do List
1. 优化ai匹配表情时的开销 (v1.4)
2. 提升表情匹配准确性 (v1.4)
3. 标注所有角色表情 (v1.4) 
4. 补全修复build脚本 (v1.5)
5. 兼容TUI (暂无计划)

## BUG记录
1. 有一定概率图片生成后自动发送没有工作（貌似图片生成太慢还是怎么的有概率触发）
2. emoji绘制需要联网，而且网络不好时，带emoji的文本可能生成失败（pilmoji库的问题）
3. 同时剪切图像和文本时总是只有文本能正常显示（图像似乎无法提取出来）
4. 切换角色时表情数组可能越界（v1.4）
5. 新增的白名单应用大概没有生效，大概（v1.4） 
6. 快捷键编辑可能需要检测输入内容是否合法（v1.4）

## 修改说明
本仓库由YangQwQ基于oplivilqo的项目二次开发，基于Tkinter实现了图形化用户界面以及其它实用功能

1. 添加了图片预览功能（会预览下一个发送的图片的样子，即使是随机生成）
2. 移除了预合成功能，改为实时缓存在内存中，切换角色时释放
3. 增加了实时预览功能
3. 添加了随机人物差分和背景的开关
4. 添加了情感自动匹配功能
5. 添加了设置界面并提供一些基本设置，包括：
   - 字体设置
   - 白名单进程编辑
   - 快捷键设置
   - 图像压缩设置
   - 情感匹配设置

## 程序界面  
<img width="802" height="754" alt="image" src="https://github.com/user-attachments/assets/7cedbf8f-0124-43af-9314-41f1b5611e9b" />

## 设置界面  
<img width="602" height="732" alt="image" src="https://github.com/user-attachments/assets/afb9e178-8772-4a15-bf59-f85f680b1f1c" />

## 使用须知
1. 目前已经能用（指直接运行main.py）
2. 代码是deepseek写的，补药喷我
3. 有想法随便提，有意思的我会尽力实现
4. build脚本还不能用（等版本稳定后再修复）
5. TUI也不能用，但是我也不一定修

## 预览
<img width="1200" height="390" alt="5f10f4239bc8a82812e505fd0c4f5567" src="https://github.com/user-attachments/assets/6fb46a8d-4fc4-4d10-80a0-ed21fbb428bf" />

<img width="1200" height="390" alt="96038673678af657e937d20617322e81" src="https://github.com/user-attachments/assets/847c331e-9274-4b60-9b42-af0a80265391" />


一个基于Python的自动化表情包生成工具，能够快速生成带有自定义文本的魔法少女的魔女裁判文本框图片。[灵感来源与代码参考](https://github.com/MarkCup-Official/Anan-s-Sketchbook-Chat-Box)

<div align="left">


## 功能特色

- 🎨 内置角色 - 内置14个角色，每个角色多个表情差分
- ⚡ 图形界面 - 使用Tkinter实现美观的用户界面
- 🖼️ 智能合成 - 自动合成背景与角色图片
- 📝 文本嵌入 - 自动在表情图片上添加文本
- 🎯 随机算法 - 智能避免重复表情
- 🀄 智能匹配 - 通过ai分析文本内容匹配情感，选择符合情感的表情
- 🔄 实时预览 - 即使随机也能预览合成效果
- 🔍 实时生成 - 图片缓存在内存中，不占硬盘空间
- 🔧 高度定制 - 支持自定义角色导入，可配置角色差分和背景是否随机等

## 使用方法
1. 下载项目代码
   ```
   git clone https://github.com/YangQwQ/Text_box-of-mahoushoujo_no_majosaiban-GUI.git
   ```
2. 安装依赖：
   ```
   pip install -r requirements.txt
   ```
3. 运行程序：
   ```
   python main.py
   ```
4. 操作说明
   - 切换角色 - 使用选框选择目标角色和表情，也可以使用快捷键，具体请看设置
   - 输入文本 - 在聊天框或文本编辑器中输入想要添加的文本
   - 图片预览 - 在发送前预览图片效果
   - 生成图片 - 按下 `Ctrl+E` 键自动生成并发送
5. 修改字体及快捷键：
   - 字体文件放置在`<根目录>/assets/fonts`文件夹中，然后打开设置即可修改
   - 快捷键请在`<根目录>/config/keybind.yml`文件中修改
6. 表情匹配设置：
   - 表情匹配功能默认关闭，需要在设置中开启
   - 可以下载ollama运行本地模型，也可以使用deepseek的api，需要其它模型的话请自行在setting.yml里面添加
   - 情感分析模型推荐使用ollama，但是可能没有deepseek准确

### 添加自定义角色
***
#### 第1步
请下载需要的角色图片，放置于`<根目录>/assets/chara/<角色名>`文件夹中，
并统一命名格式为`<角色名> (<差分编号>)`，如图：
<img width="230" height="308" alt="image" src="https://github.com/user-attachments/assets/892b6c8e-b857-482b-94be-07ad240f2a3b" />
> 注意角色名与编号之间的空格

#### 第2步
修改**2个**配置文件，位于`<根目录>/config`文件夹：
1. `chara_meta.yml`: 包含角色元数据及表情情感标注，在末尾添加：
```yaml
ema:                  # 填写角色名（与你的文件夹名相同）
  full_name: 樱羽艾玛  # 填写角色全名（仅用于可读性显示）
  emotion_count: 8    # 填写差分数量
  font: font3.ttf     # 填写使用的字体
  "无感情": [2,3]     # 填写无感情差分的编号，当与其它情感均不匹配时会选择这个发送
  "愤怒": [1,3]
  "嫌弃": [5]
  "疑惑": [5]
  "惊讶": [7]
  "伤心": [5]
  "害羞": [4,8]
  "开心": [2,6]
  "恐惧": [5]
  "无语": [5,3]
  "大笑": [6]
```
其中表情的情感标注不是必须的，如果不使用ai来自动匹配的话，可以整段删除

2. `text_configs.yml`: 包含角色名称的显示方法，在末尾添加：
```yaml
warden:
  - text: 典 # 文字内容
    position: [ 759, 63 ]  # 绝对坐标
    font_color: [ 195, 209, 231 ]  # 颜色RGB值
    font_size: 196  # 文字大小
  - text: 狱 # 下面以此类推
    position: [ 948, 175 ]
    font_color: [ 255, 255, 255 ]
    font_size: 92
  - text: 长
    position: [ 1053, 117 ]
    font_color: [ 255, 255, 255 ]
    font_size: 147
  - text: ""
    position: [ 0, 0 ]
    font_color: [ 255, 255, 255 ]
    font_size: 1
```
另外，若要使用角色，请下载对应角色文件夹并放到项目文件夹的`assets/chara`文件夹中

## 更新日志

### v1.4
- 改为使用openai模块与ai通信
- 修复了ai模型切换时可能出现的bug
- 标注了部分角色差分的情感，但是我个木头脑袋感觉出来的不一定准，有没有人能帮帮我（
- 新增了白名单进程编辑功能，增加了快捷键编辑功能（大概有潜在bug）

### v1.3

- 新增了快捷切换人物背景的热键（含六个可自定义的快捷角色切换位、上下切换表情/背景/角色的键位以及），但是目前修改键位需要在keymap.yml里改
- 新增了暂停和启用按键监听的热键，默认为ctrl+alt+p
- 添加了自定义字体的功能（字体文件需要放在assets/font文件夹中），字体大小也可以在设置中自定义
- 添加了图像压缩功能（因为剪贴板的特性，所以是直接削减像素压缩）
- 减少了不必要的copy操作来提升图像合成性能
- 添加了表情自动匹配功能，可以用deepseek或者在ollama上运行的模型来分析文本情感
- 修复了以下bug：
  + emoji绘制功能已修复，初次绘制的emoji可能需要联网获取图像
  + 修复了合成图片时的多线程导致的性能问题

### v1.2

- 直接把fork来的项目扔给ai重做了
- 给随机功能添加了开关
- 移除了预合成功能，改为实时预览，并直接在预览图的基础上合成最后的文字
- 添加了图片预览功能（会预览下一个发送的图片的样子，即使是随机生成）
- 精简了部分代码（指删了部分ai写的意义不明的操作）
- 切换人物时自动释放内存中缓存的图片
- 修复了以下bug：
  + 程序最小化后有概率无法正常监听按键
  + 修复了预览不正常的bug，现在可以正常预览了

### v1.1.5

- 增添了自主切换表情功能
- 将特殊字体改为红色


### 许可证

本项目基于MIT协议传播，仅供个人学习交流使用，不拥有相关素材的版权。进行分发时应注意不违反素材版权与官方二次创造协定。

## 结语

受B站上MarkCup做的夏目安安传话筒启发，以夏目安安传话筒为源代码编写了这样一个文本框脚本。
由于本人是初学者，第一次尝试写这种代码，有许多地方尚有改进的余地，望多多包含。

更新日志怎么写啊

<div align="right">
  
### 以上. 柊回文————2025.11.15










